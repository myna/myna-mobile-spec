## Myna Mobile API Version 2

This document describes forthcoming mobile client libraries for Myna. The same basic template will be used for client libraries for iOS, Android, and HTML 5 mobile apps.

The main purpose of these libraries is to abstract away the problems of communication with the Myna servers. The client libraries will download experiment data and cache it on the device. Tests will be run locally without the need for constant communication with the Myna servers. Test results will be synced back to the servers as and when a network connection is available.

The examples below are written using Javascript and Objective-C. The native client library for Android will follow a similar pattern in Java.

This is version 2 of the spec, which is a simplification of version 1. It is likely that some of the functionality of version 1 will be retained under the hood for power users.

## Configuring the Myna client

The top-level factory method `Myna.configure` creates a `MynaClient` given a set of API credentials and experiment defaults. The intention is that the call to `Myna.configure` can be generated by the Myna dashboard and tweaked by the developer.

    var mynaClient = Myna.configure({
        apiKey: "87188abc-84dd-11e2-b26a-109add4dfc1c",
        experiments: [
            "experiment1": {
                // defaults for experiment1
            },
            "experiment2": {
                // defaults for experiment2
            }
        ]
    });

iOS version:

    MynaClient *mynaClient =
        [Myna clientWithApiKey: @"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"
                      defaults: @{ ... }];

Hidden implementation details:

 - Calling this method may trigger an asynchronous API call to the Myna servers to download experiment data.

 - Downloaded experiment data will be cached on the device and periodically updated in response to changes on the Myna dashboard.

 - The client works on- or offline. If it can't retrieve data from Myna's servers, it enters *offline mode* and uses the defaults provided instead.

## Viewing variants and recording conversions

Instances of `MynaClient` are created by `Myna.configure` and provide the main interface to access experiments, view variants and record conversions:

### mynaClient.viewVariant method

View a variant:

    // Allow Myna to suggest which variant to display:
    mynaClient.viewVariant("experimentId", function(variant) {
        // ... update app display to show the specified variant ...
    });

    // View a particular variant, regardless of Myna's suggestions:
    mynaClient.viewVariant("experimentId", "variantId", function(variant) {
        // ... update app display to show the specified variant ...
    });

iOS version:

    [mynaClient viewVariantInExperiment: @"experimentId"
                        successCallback: ^(MynaVariant *variant) {
                                             // ...
                                         }];

    [mynaClient viewVariantInExperiment: @"experimentId"
                              variantId: @"variantId"
                        successCallback: ^(MynaVariant *variant) {
                                             // ...
                                         }];

Hidden implementation details:

 - If experiment data has not already been downloaded from the Myna servers, this method may trigger or wait for an API call to request the data before invoking the callback.

 - If experiment data cannot be retrieved from the Myna servers, the client will switch to *offline mode* and will use data from the experiment defaults instead.

 - An asynchronous API call may be made to record that the variant has been viewed. This will not interfere with the execution of the callback.

 - If the Myna servers cannot be contacted to record the view, the API call will be queued until a network connection can be established.

### mynaClient.recordConversion method

Record a conversion for the last-viewed variant of the specified experiment:

    // Record a conversion for the last-viewed variant:
    mynaClient.recordConversion("experimentId");

    // Record a conversion for a specifid variant, regardless of which variant was last viewed:
    mynaClient.recordConversion("experimentId", "variantId");

iOS version:

    [mynaClient recordConversion: @"experimentId"];

    [mynaClient recordConversion: @"experimentId" variant: @"variantId"];

Hidden implementation details:

 - If `viewVariant` has not been called or the client is in offline mode, this method call will result in a noop.

 - An asynchonous API call may be triggered to send the data to the Myna servers.

 - If the Myna servers cannot be contacted to record the conversion, the API call will be queued until a network connection can be established.

## Experiment and variant metadata

Every experiment and variant has associated metadata that developers can use to store variables that can be configured from the Myna dashboard:

    // Retrieve metadata for an experiment:
    var meta1 = mynaClient.getExperimentMetadata("experimentId")

    // Retrieve metadata for a variant:
    var meta2 = mynaClient.getVariantMetadata("experimentId", "variantId")

iOS version:

    [mynaClient metadataForExperiment: @"experimentId"];

    [mynaClient metadataForExperiment: @"experimentId" variant: @"variantId"];

A metadata object is a JSON-like structure that can be queried by string key:

    var color = meta1.homepage.button.color;

iOS version:

    NSString *str = [[[meta1 objectForKey @"homepage"] objectForKey @"button"] objectForKey @"color"];

Hidden implementation details:

 - If the client is in *offline mode*, default metadata specified in the call to `Myna.configure` will be used instead.

## Cached views and conversions

By default, when `viewVariant` is called for the first time, the variant suggested by the server is cached in local storage on the device. The cached variant is reloaded by future calls to `viewVariant` without sending further events to the server. Similarly, the first call to `rewardConversion` adds data to the cache to prevent duplicate rewards.

Cached views and conversions can be cleared at an experiment or client level as follows:

    // Clear cached data for a single experiment:
    mynaClient.clearCache("experimentId");

    // Clear cached data for all experiments:
    mynaClient.clearCache();

iOS version:

    [mynaClient clearCache: @"experimentId"];

    [mynaClient clearCache];

Once the cache is cleared, the client will attempt to asynchronously download new experiment data from the servers.

## App updates

The cache is sensitive to changes in the application's version number. Changes to the version number will cause the cache to be cleared and new data to be retrieved from the server.
